/**
 * @name construct
 * WebGL framework using markup for declarative 3Ds
 *
 * Version: 0.5.0 (Sat, 20 May 2023 06:52:33 GMT)
 * Source: http://github.com/makesites/construct
 *
 * @author makesites
 * Initiated by: Makis Tracend (@tracend)
 * Distributed through [Makesites.org](http://makesites.org)
 *
 * @cc_on Copyright Â© Makesites.org
 * @license Released dual-licensed: Mozilla Public License v2.0, GNU Affero General Public License v3.0
 */
!function(){var t=function(t){var e=null,i=[],s=!1;this.add=function(n){s?n.apply(t,e):i.push(n)},this.resolve=function(){if(!s){e=arguments,s=!0;for(var n=i.shift();n;)n.apply(t,arguments),n=i.shift();i=null}}},e={uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,i="x"==t?e:3&e|8;return i.toString(16)})},extend:function(){var t=Array.prototype.slice.call(arguments),e={};for(var i in t){var s=t[i];for(var n in s)s[n]&&s[n].constructor&&s[n].constructor===Object?(e[n]=e[n]||{},e[n]=arguments.callee(e[n],s[n])):e[n]=s[n]}return e}},i={"en-US":{error:{"no-backbone":"Backbone is not available: http://backbonejs.org/","no-jquery":"jQuery is not available: http://jquery.com/","no-jquery-three":"jQuery Three is required: http://github.com/makesites/jquery-three","no-backbone-app":"This function requires Backbone APP: http://github.com/makesites/backbone-app"}}};construct=function(t,i){if(t=t||{},t.require&&e.extend(s.require,t.require),i&&(construct.callback=i),"undefined"!=typeof require)require.config(s.require),require(s.require.deps,construct.init);else{if("undefined"==typeof Backbone)return construct.log("error","no-backbone");if("undefined"==typeof jQuery)return construct.log("error","no-jquery");if("undefined"==typeof jQuery.fn.three)return construct.log("error","no-jquery-three");construct.init()}e.extend(construct.options,t)},construct.init=function(){if(construct.promise.resolve(construct.options),s.init.router){if(s.require)new APP({require:!0},function(t){var e=new t;window.app=e,Backbone.history.start({pushState:construct.options.pushState||!1}),construct.callback&&construct.callback(e)});else{var t=new APP;window.app=t,Backbone.history.start(),construct.callback&&construct.callback(t)}return this}},construct.register=function(t){t&&t.update&&construct.loop.push(t.update)},construct.configure=function(t){construct.promise.add(t)},construct.lang=function(t){e.extend(i,t)},construct.options={},construct.loop=[],construct.update=function(t){},construct.log=function(t,e){if(t&&e){var s=navigator.language?navigator.language:navigator.userLanguage,n=i[s][t][e]||i["en-US"][t][e]||t+": "+e;console.log(n)}},construct.promise=new t,construct.config=function(t){e.extend(s,t)};var s={init:{router:!1},require:{deps:[]}};construct.promise.add(function(){"undefined"==typeof APP&&(window.APP={});var t=APP.Model||Backbone.Model,i=APP.Collection||Backbone.Collection;APP.Models.Params=Backbone.Model.extend({defaults:{}}),APP.Models.User=t.extend({options:{autofetch:!1},defaults:{admin:!0}}),APP.Models.Asset=t.extend({options:{autofetch:!1},defaults:{x:0,y:0,editable:!0}}),APP.Models.Mesh=t.extend({options:{autofetch:!1},defaults:{position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]}}),APP.Models.Sprite=t.extend({options:{autofetch:!1},defaults:{position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]}}),APP.Collections.Users=i.extend({}),APP.Collections.Assets=i.extend({}),APP.Collections.Objects=Backbone.Model.extend({initialize:function(t){return this.length=0,Backbone.Model.prototype.initialize.call(this,t)},set:function(t,e,i){if(i=i||{},i.unset)this.length--;else for(var s in t)t[s]._name=s,this.length++,this._setupObject(t[s]);return Backbone.Model.prototype.set.apply(this,arguments)},add:function(t){var i={},s=e.uuid();i[s]=t,this.set(i)},_setupObject:function(t){var e=this;t.state.get("rendered")&&(this.trigger("find",t),this.trigger("parent",t)),t.on("parent",function(){e.trigger("parent",t)}),t.on("render",function(){e.trigger("find",t)}),t.on("find",function(t){e.trigger("find",t)}),t.on("lod",function(t){e.trigger("lod",t)}),t.on("pause",function(t){e.trigger("pause",t)}),t.on("remove",_.bind(this._removed,this))},_removed:function(t){this.unset(t._name)}}),APP.Models.Layers=Backbone.Model.extend({set:function(t){for(var e in t){var i=t[e];i.on("find",_.bind(this._bubbleFind,this)),i.on("lod",_.bind(this._bubbleLOD,this))}return Backbone.Model.prototype.set.apply(this,arguments)},_bubbleFind:function(t){this.trigger("find",t)},_bubbleLOD:function(t){this.trigger("lod",t)}})}),construct.promise.add(function(){"undefined"==typeof APP&&(window.APP={});var t=(APP.Model||Backbone.Model,APP.Collection||Backbone.Collection,APP.View||Backbone.View);APP.Layout||Backbone.Layout;APP.Layers={},APP.Meshes={},APP.Sprites={},APP.Actors={};var e=function(){var t=new Backbone.Model;return"object"==typeof this.state&&(this.state.toJSON&&(this.state=this.state.toJSON()),t.set(this.state)),t},i=function(){var t=new APP.Models.Params;return"object"==typeof this.params&&(this.params.toJSON&&(this.params=this.params.toJSON()),t.set(this.params)),t};APP.Views.Main3D=t.extend({el:".main",options:{renderTarget:"shadow-root",autoRender:!1},state:{paused:!1},initialize:function(e){return _.bindAll(this,"setup"),this.objects=new APP.Collections.Objects,this.layers=new APP.Models.Layers,this.state=this.setupState(),this.params=this.setupParams(),"undefined"!=typeof this.el&&setTimeout(this.setup,100),this.objects.on("find",_.bind(this._find,this)),this.layers.on("find",_.bind(this._find,this)),this.objects.on("lod",_.bind(this._updateLOD,this)),this.layers.on("lod",_.bind(this._updateLOD,this)),this.objects.on("pause",_.bind(this.togglePause,this)),this.on("pause",_.bind(this.togglePause,this)),t.prototype.initialize.call(this,e)},setup:function(){this.$3d=$(this.el).three({watch:!0},_.bind(this._start,this)),$("body").on("update",this.el,_.bind(this._update,this))},setupParams:i,setupState:e,start:function(t){},update:function(){},_start:function(t){this.$3d=t,this.$3d.clock=new THREE.Clock,this.render(),this.start(t)},_update:function(t){if(this.el===t.target.el){for(var e in this.objects.attributes)this.objects.get(e).trigger("update",t);for(var i in this.layers.attributes)this.layers.get(i).trigger("update",t);this.update(t)}},_updateLOD:function(t){this.$3d.active.camera&&t.update(this.$3d.active.camera)},_find:function(t){var e=$(t.el).find("[data-id]").length>0?$(t.el).find("[data-id]").attr("data-id"):$(t.el).attr("data-id");if(!_.isUndefined(e)){var i=this.$3d.get(e);t.object=i,t.trigger("start")}},togglePause:function(t){this.state.set("paused",!this.state.get("paused")),this.$3d.options.paused=this.state.get("paused")},_unPause:function(){this.state.set("paused",!1),this.$3d.options.paused=!1,this.trigger("unpause")}});var s=APP.Mesh||t;APP.Mesh=s.extend({options:{speed:!1,bind:"sync"},events:{},state:{rendered:!1},initialize:function(t){if(t=t||{},!t.models){this.state=this.setupState(),this.params=this.setupParams(),this.data=this.data||t.data||this.model||new APP.Models.Mesh,t.params&&this.params.set(t.params),this.trigger("parent"),this.on("update",_.bind(this._update,this)),this.on("start",_.bind(this._start,this)),_.bindAll(this,"_updateLOD"),this._setupEvents();var e=this;setTimeout(function(){return s.prototype.initialize.call(e,t)},100)}},setupParams:i,setupState:e,start:function(){},toJSON:function(){var t={};return t.data=this._toJSON(),t.params=this.params.toJSON(),this.options.inRender&&(t.options=this.options),t},_start:function(){var t=this.data.get("position"),e=APP.Models.Mesh.prototype.defaults.position;_.isUndefined(t)||t===e||this.object.position.set(t[0],t[1],t[2]);var i=this.data.get("rotation"),s=APP.Models.Mesh.prototype.defaults.rotation;_.isUndefined(i)||i===s||this.object.rotation.set(i[0],i[1],i[2]);var n=this.data.get("scale"),o=APP.Models.Mesh.prototype.defaults.scale;_.isUndefined(n)||n===o||this.object.scale.set(n[0],n[1],n[2]),this.start()},_preRender:function(){if(this.el){var t=$("<body></body>").append(this.el).html().toString();"<div></div>"==t&&delete this.el}this.preRender()},render:function(){return this.state.get("rendered")?void 0:s.prototype.render.call(this)},_postRender:function(){return this.state.set("rendered",!0),this.trigger("render"),s.prototype._postRender.call(this)},_update:function(t){if(_.isUndefined(this.object))return this.trigger("render");if(_.isNull(this.object))return this.disable();if(this.options.speed&&this.object){var e=this.options.speed,i=this.object.position;e.x&&(i.x+=e.x),e.y&&(i.y+=e.y),e.z&&(i.z+=e.z),this.object.position.set(i.x,i.y,i.z)}if(this.object&&this.object.objects&&this._updateLOD(this.object),this.objects)for(var s in this.objects.attributes)this.objects.get(s).trigger("update",t);this.update(t)},update:function(t){},_updateLOD:function(){this.trigger("lod",this.object)},remove:function(){this.trigger("remove",this);var t=this.object.parent;return t&&t.remove(this.object),this.undelegateEvents(),this.$el.removeData().unbind(),s.prototype.remove.call(this)},disable:function(){this.off("update",_.bind(this._update,this)),this.off("start",_.bind(this._start,this))},customFilter:function(){},_validate:function(){return!0},_setupEvents:function(){$(this.el).on("css-filter",_.bind(this._customFilter,this))},_customFilter:function(){this.customFilter()}}),APP.Meshes.Static=APP.Mesh.extend({}),APP.Meshes.Dynamic=APP.Meshes.Static.extend({options:{moveStep:3,rotateStep:.5},params:{move:{left:0,right:0,up:0,down:0,forward:0,back:0,pitchDown:0,pitchUp:0,yawRight:0,yawLeft:0,rollRight:0,rollLeft:0}},initialize:function(t){return this.objects=new APP.Collections.Objects,this.objects.on("find",_.bind(this._find,this)),this.objects.on("parent",_.bind(this._self,this)),APP.Meshes.Static.prototype.initialize.call(this,t)},_find:function(t){this.trigger("find",t)},_self:function(t){t.parent=this.object?this.object:null},tmpQuaternion:new THREE.Quaternion,moveVector:new THREE.Vector3(0,0,0),rotationVector:new THREE.Vector3(0,0,0),updateMovementVector:function(){var t=this.params.get("move");this.moveVector.x=-t.left+t.right,this.moveVector.y=-t.down+t.up,this.moveVector.z=-t.forward+t.back},updateRotationVector:function(){var t=this.params.get("move");this.rotationVector.x=-t.pitchDown+t.pitchUp,this.rotationVector.y=-t.yawRight+t.yawLeft,this.rotationVector.z=-t.rollRight+t.rollLeft}}),APP.Meshes.Avatar=APP.Meshes.Dynamic.extend({}),APP.Meshes.NPC=APP.Meshes.Avatar.extend({}),APP.Meshes.Player=APP.Meshes.Avatar.extend({}),APP.Sprite=t.extend({initialize:function(e){if(e=e||{},!e.models){this.state=this.setupState(),this.params=this.setupParams(),this.data=this.data||e.data||this.model||new APP.Models.Sprite,e.params&&this.params.set(e.params),this.object=e.object,this.on("update",_.bind(this._update,this)),this._start&&this._start();var i=this;setTimeout(function(){return t.prototype.initialize.call(i,e)},100)}},setupParams:i,setupState:e,_start:function(){},_update:function(){},toJSON:function(){var t={};return t.data=this._toJSON(),t.params=this.params.toJSON(),this.options.inRender&&(t.options=this.options),t}}),APP.Sprites.Static=APP.Sprite.extend({}),APP.Sprites.Animated=APP.Sprite.extend({options:{timeElapsed:0},_start:function(){var t=this.object.children[0].material.map,e=this.model.get("tiles");return this.tilesHorizontal=e[0],this.tilesVertical=e[1],this.numberOfTiles=this.model.get("total"),t.wrapS=t.wrapT=THREE.RepeatWrapping,t.repeat.set(1/this.tilesHorizontal,1/this.tilesVertical),this.tileDisplayDuration=this.model.get("timeout"),this.currentDisplayTime=0,this.currentTile=0,this.options.lastTime=(new Date).getTime(),APP.Sprite.prototype._start.call(this)},_update:function(t){var e=(new Date).getTime(),i=e-this.options.lastTime,s=this.object.children[0].material.map;if(i>this.tileDisplayDuration){this.options.lastTime=e,this.currentTile++,this.currentTile==this.numberOfTiles&&(this.currentTile=0);var n=this.currentTile%this.tilesHorizontal;s.offset.x=n/this.tilesHorizontal;var o=Math.floor(this.currentTile/this.tilesHorizontal);s.offset.y=1-o/this.tilesVertical}return APP.Sprite.prototype._update.call(this,t)}}),APP.Views.Asset=t.extend({}),APP.Layer=Backbone.Collection.extend({initialize:function(t,e){t=t||[],this.el=this.el||e.el||null,this.objects=new APP.Collections.Objects;for(var i=0;i<t.length;i++){var s=t.get(i)||{};this.add(s)}return this.on("update",_.bind(this._update,this)),this.objects.on("find",_.bind(this._find,this)),this.objects.on("lod",_.bind(this._bubbleLOD,this)),this.objects.on("change",_.bind(this._refresh,this)),APP.Collection.prototype.initialize.call(this,null,e)},add:function(t){if(t=t||{},t.models)return this.addCollection(t);var e=new this.object({parentEl:this.el,append:!0});this.objects.add(e),t.id=e._name||e.id||null;var i=new Backbone.Model(t);return Backbone.Collection.prototype.add.call(this,i)},addCollection:function(t){var e=t.toJSON();this.models;for(var i in e){var s=this._matchData(e[i],i);s&&(e[i].id=s);var n=s?this.get(s):this.at(i);n?n.set(e[i]):this.set(e[i],{merge:!1,add:!0,remove:!1})}},update:function(t){},refresh:function(t){},_update:function(t){for(var e in this.objects.attributes)this.objects.get(e).trigger("update",t);this.update(t)},_matchData:function(t,e){var i=(t.id,Object.keys(this.objects.toJSON()));return t.id&&i.indexOf(t.id)>0?t.id:i[e]?i[e]:null},_refresh:function(t){this.refresh(t)},_find:function(t){this.trigger("find",t)},_bubbleLOD:function(t){this.trigger("lod",t)}})}),construct.promise.add(function(){"undefined"==typeof APP&&(window.APP={});var t=APP.Router||Backbone.Router;APP.Routers.Default=APP.Routers.Default||t.extend({initialize:function(e){return _.bindAll(this,"index"),this.data=new Backbone.Model,console.log("init","APP.Routers.Default"),t.prototype.initialize.call(this,e)},routes:{"":"index"},index:function(){console.log("Construct.js is running..."),_.isUndefined(APP.Main)||(this.main=new APP.Main({data:this.data}))}})})}();